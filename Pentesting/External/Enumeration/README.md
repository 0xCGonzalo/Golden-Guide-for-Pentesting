# External Enumeration Methodology

Find all the possible assets of your target.

# Assets discoveries

> You were said that everything belonging to some company is inside the scope, and you want to figure out what this company actually owns.

The goal of this phase is to obtain all the **companies owned by the main company** and then all the **assets** of these companies. To do so, we are going to:

1. Find the acquisitions of the main company, this will give us the companies inside the scope.
2. Find the ASN (if any) of each company, this will give us the IP ranges owned by each company
3. Use reverse whois lookups to search for other entries (organisation names, domains...) related to the first one (this can be done recursively)
4. Use other techniques like shodan `org`and `ssl`filters to search for other assets (the `ssl` trick can be done recursively).

## Acquisitions

First of all, we need to know which **other companies are owned by the main company**.

One option is to visit [https://www.crunchbase.com/](https://www.crunchbase.com), **search** for the **main company**, and **click** on "**acquisitions**". There you will see other companies acquired by the main one.

Other option is to visit the **Wikipedia** page of the main company and search for **acquisitions**.

> Ok, at this point you should know all the companies inside the scope. Lets figure out how to find their assets.

## ASNs and RIRs

### ASNs

> An autonomous system number (**ASN**) is a **unique number** assigned to an **autonomous system** (AS) by the **Internet Assigned Numbers Authority (IANA)**.

> An **AS** consists of **blocks** of **IP addresses** which have a distinctly defined policy for accessing external networks and are administered by a single organisation but may be made up of several operators.

It's interesting to find if the **company have assigned any ASN** to find its **IP ranges.** 

It will be interested to perform a **vulnerability test** against all the **hosts** inside the **scope** and **look for domains** inside these IPs.

You can search by **company name**, by **IP** or by **domain** in **[**https://bgp.he.net/**](https://bgp.he.net)**.

### RIRs

> ICANN (Internet Corporation for Assigned Names and Numbers) is an organization that operates on a multinational/international level and is responsible for assigning IP protocol addresses, protocol identifiers, and domain system management functions and the administration of the root server system.

> ICANN delegates Internet resources to RIRs, and in turn RIRs follow their regional policies for further sub-delegation of resources to their clients, which include service providers and organizations for their own use.

> An RIR (Regional Internet Registry or Regional Internet Registry) is an organization that oversees the allocation and registration of Internet number resources within a particular region of the world. Resources include IP addresses (both IPv4 and IPv6) and autonomous system numbers (for use in BGP routing).

There are currently 5 RIRs in operation and you should search according to the region of the company:

- [**AFRINIC**](https://www.afrinic.net) (Africa)
- [**Arin**](https://www.arin.net/about/welcome/region/) (North America / Anglo American)
- [**APNIC**](https://www.apnic.net) (Asia / Pacific Region)
- [**LACNIC**](https://www.lacnic.net) (Latin America / Caribbean),
- [**RIPE NCC**](https://www.ripe.net) (Europe / Middle East / Central Asia). 

You can find the IP ranges of an organisation also using [http://asnlookup.com/](http://asnlookup.com) (it has free API).

You can find the IP and ASN of a domain using [http://ipv4info.com/](http://ipv4info.com).

## Scan for Vulnerabilities

At this point we known **all the assets inside the scope**, so if you are allowed you could launch some **vulnerability scanner** (Nessus, OpenVAS) over all the hosts.

Also, you could launch some port scans, go to [**Network Scan Section**](https://github.com/0xCGonzalo/Golden-Guide-for-Pentesting/tree/master/Pentesting/External/Network%20Scan) **and use services like** shodan **to find** open ports.

_Note that sometimes the domain is hosted inside an IP that is not controlled by the client, so it's not in the scope, be careful._

# Domains

> You now know all the companies and assets within your target scope, it's time to find the domains within scope.

## Reverse DNS

> A reverse DNS lookup is a DNS query for the domain name associated with a given IP address. This accomplishes the opposite of the more commonly used forward DNS lookup, in which the DNS system is queried to return an IP address.
Standards from the Internet Engineering Task Force (IETF) suggest that every domain should be capable of reverse DNS lookup, but as reverse lookups are not critical to the normal function of the Internet, they are not a hard requirement. As such, reverse DNS lookups are not universally adopted.

As you have found all the IP ranges of the domains you could try to perform **reverse dns lookups** on those **IPs to find more domains inside the scope**. 

Try to use some dns server of the victim or some well-known dns server (1.1.1.1, 8.8.8.8)

```bash
dnsrecon -r <DNS Range> -n <IP_DNS>   # DNS reverse of all of the addresses
dnsrecon -d facebook.com -r 157.240.221.35/24 # Using facebooks dns
dnsrecon -r 157.240.221.35/24 -n 1.1.1.1 # Using cloudflares dns
dnsrecon -r 157.240.221.35/24 -n 8.8.8.8 # Using google dns
```

For this to work, the administrator has to enable manually the PTR (pointer). You can also use a online tool for this info: [http://ptrarchive.com/](http://ptrarchive.com)

## All Domain in Host

When a user uses DNS Round Robin, they should feel this:
```
nslookup target.com
[RESULTS]
nslookup target.com
[RESULTS]
```
If both answers are different, this setting has probably been applied.

> A shared web hosting service is a web hosting service in which many websites reside on a web server connected to the Internet. The website will share a physical server with one or more websites.

If this situation occurs, you can try to find domains that share the same IP address or subnet using **Reverse IP Lookup**:

- [HackerTarget](https://hackertarget.com/reverse-ip-lookup/)
- [DNS Lytics](https://dnslytics.com/reverse-ip)
- [You Get Signal](https://www.yougetsignal.com/tools/web-sites-on-web-server/)

## Reverse Whois (loop)

Inside a **whois** you can find a lot of interesting **information** like **organisation name**, **address**, **emails**, phone numbers, and **more assets related to the company** if you perform **reverse whois lookups by any of those fields** (for example, other whois records where the same email appears that seems interesting).

You can use online tools like:

* [https://viewdns.info/reversewhois/](https://viewdns.info/reversewhois/) - **Free**
* [https://domaineye.com/reverse-whois](https://domaineye.com/reverse-whois)  - **Free**
* [https://www.reversewhois.io/](https://www.reversewhois.io)  - **Free**
* [https://www.whoxy.com/](https://www.whoxy.com) - **Free** web, not free API.
* [http://reversewhois.domaintools.com/](http://reversewhois.domaintools.com) - Not free
* [https://drs.whoisxmlapi.com/reverse-whois-search](https://drs.whoisxmlapi.com/reverse-whois-search) - Not Free (only **100 free** searches)
* [https://www.domainiq.com/](https://www.domainiq.com) - Not Free

You must have a paid subscription to use whois freely, otherwise the message "REDACTED FOR PRIVACY" will be displayed on some data.

Also, you can automate this task using [**DomLink** ](https://github.com/vysecurity/DomLink)(requires a whoxy API key):
```
python3 domLink.py -D target.com -o output.txt
```
**Note that you can use this technique to discover more domain names every time you find a new domain.**

## Other Ways

### Assetfinder

Tool that look for **domains related** with a main domain and **subdomains** of them:

- [**Assetfinder** ](https://github.com/tomnomnom/assetfinder)

```
assetfinder -subs-only target.com
```

# Subdomains

## Why so Many Tools and Techniques?

The more techniques used, the more chances to find interesting subdomains that others might have missed.

Some bug hunters recommend using only a handful of tools (like Amass, Massdns, Subfinder & Gobuster). But people who have a bad Internet connection & no VPS won’t be able to use these highly effective & fast tools. So choose whatever works for you!

## Methods

- Scraping
- Brute-force
- Alterations & permutations of already known subdomains
- Online DNS tools
- SSL certificates
- Certificate Transparency
- Search engines
- Public datasets
- DNS aggregators
- Git repositories
- Text parsing (HTML, JavaScript, documents…)
- VHost discovery
- ASN discovery
- Reverse DNS
- Zone transfer (AXFR)
- DNSSEC zone walking
- DNS cache snooping
- Content-Security-Policy HTTP headers
- Sender Policy Framework (SPF) records
- Subject Alternate Name (SAN)

## Techniques

### DNS Recon
```
dnsrecon -a -d target.com
dnsrecon -d target.com
```

### Dorks
Google, Bing
```
site:target.com -www
site:target.com -site:www.target.com
site:*.target.com -site:www.target.com -site:help.target.com
```

### Sublist3r
```
sublist3r -d target.com
```

### Knockpy
```
python3 knockpy.py target.com
```

### Altdns
You need a previously wordlist of subdomains for take 

Generate a list of altered subdomains:
```
./altdns.py -i known-subdomains.txt -o new_subdomains.txt
```
Generate a list of altered subdomains & resolve them:
```
./altdns.py -i known-subdomains.txt -o new_subdomains.txt -w words.txt -r -s results_output.txt
```

Other options
- -w wordlist.txt: Use custom wordlist (default altdns/words.txt)
- -t 10: Number of threads
- -d $IP: Use custom resolver

### Amass
```
amass enum -d target.com
amass enum -d target.com -r 8.8.8.8
amass enum -active -ip -d target.com
amass enum -active -ip -d target.com -r 8.8.8.8
```

### Censys
```
python censys_subdomain_finder.py target.com
```

### Subfinder
```
subfinder -d target.com
```

### The Harvester
You must configure all the API KEYS before running it for best performance.
```
theHarvester -d target.com -b all
```

### Certificates

- [Search for Certificates](https://crt.sh)

### FindOmain Linux
```
./findomain-linux -t bupa.cl --quiet
```

### OneForAll
```
python3 oneforall.py --target example.com run
python3 oneforall.py --targets ./example.txt run
python3 oneforall.py --target target.com --dns False --req False run
```

### ReconFTW
```
./reconftw.sh -d target.com -s
```

### Omnisint
```
curl https://sonar.omnisint.io/subdomains/<target.com>
```

### DNS and VirtualHost Brute force

Let's try to find new **subdomains** brute-forcing DNS servers using possible subdomain names.

For this action you will need some common subdomains lists like:

* [https://gist.github.com/jhaddix/86a06c5dc309d08580a018c66354a056](https://gist.github.com/jhaddix/86a06c5dc309d08580a018c66354a056)

```
gobuster dns -d mysite.com -t 50 -w subdomains.txt
gobuster vhost -u https://mysite.com -t 50 -w subdomains.txt
wfuzz -c -w /usr/share/wordlists/SecLists/Discovery/DNS/subdomains-top1million-20000.txt --hc 400,404,403 -H "Host: FUZZ.target.com" -u http://target.com -t 100
wfuzz -c -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-5000.txt --hc 400,404,403,XXX -H "Host: FUZZ.target.com" -u http://target.com -t 20 -L # Follow Redirection
wfuzz -c -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-5000.txt --hc 400,404,403,XXX -H "Host: FUZZ.target.com" -u http://target.com -t 20 -L -Z # Ignore Errors
```

### CORS Brute Force

Sometimes you will find pages that only return the header _**Access-Control-Allow-Origin**_ when a valid domain/subdomain is set in the _**Origin**_ header. 

In these scenarios, you can abuse this behavior to **discover** new **subdomains**.

```
ffuf -w subdomains-top1million-5000.txt -u http://10.10.10.208 -H 'Origin: http://FUZZ.crossfit.htb' -mr "Access-Control-Allow-Origin" -ignore-body
```

### Buckets Brute Force

While looking for **subdomains** keep an eye to see if it is **pointing** to any type of **bucket**, and in that case [**check the permissions**](../pentesting/pentesting-web/buckets/)**.**\
Also, as at this point you will know all the domains inside the scope, try to [**brute force possible bucket names and check the permissions**](../pentesting/pentesting-web/buckets/).

===================== PENDING TO COMPLETE =====================

## Online Tools

### Subdomain Online

- [NMMapper](https://www.nmmapper.com/sys/tools/subdomainfinder/)
- [DNS Dumpster](https://dnsdumpster.com/)
- [Spyse](https://spyse.com/tools/subdomain-finder)
- [Netcraft](https://searchdns.netcraft.com/)
- [VirusTotal](https://www.virustotal.com/gui/home/search)
- [ViewDNS](https://viewdns.info/)

### Search Engines

- [Baidu](https://www.baidu.com/)
- [Yahoo](https://espanol.yahoo.com/?p=us&guccounter=1)
- [Google](https://www.google.com/)
- [Bing](https://www.bing.com/)
- [Yandex](https://www.yandex.ru/)
- [Exalead](https://www.exalead.com/search)
- [Dogpile](http://www.dogpile.com/)
- [Duckduckgo](https://duckduckgo.com/)
- [Riddler](https://riddler.io/)

### Specialized Search Engines

- [ZoomEye](https://www.zoomeye.org/)
- [FOFA](https://fofa.so/)
- [Shodan](https://www.shodan.io/)
- [ThreatCrowd](https://www.threatcrowd.org/)

### Certificate Transparency

- [Crt.sh](https://crt.sh/?q=%25target.com)
- [Certspotter.com](https://certspotter.com/api/v0/certs?domain=target.com)
- [Google Transaprency report](https://transparencyreport.google.com/https/certificates)
- [Facebook CT Monitoring](https://developers.facebook.com/tools/ct)
- [Certstream](https://certstream.calidog.io/)
- [CertDB](https://certdb.com/)
- [Censys.io](https://censys.io/)

# Web Servers Hunting

So far you have found all the **companies** and their **assets**, and you know **IP ranges, domains and subdomains** within reach.

Time to search for **web servers**.

In the previous steps you have probably already performed some **recon of the IPs and domains discovered**, so you may have **already found all the possible web servers**. However, if you haven't we are now going to see some **fast tricks to search for web servers** inside the scope.

Please, note that this will be **oriented for web apps discovery**, so you should **perform the vulnerability** and **port scanning** also (**if allowed** by the scope).

You just pass a list of domains and it will try to connect to port 80 (http) and 443 (https). Additionaly, you can indicate to try other ports:

```
masscan -p80,443,8000-8100,8443 199.66.11.0/24
cat /tmp/domains.txt | httprobe # Test all domains inside the file for port 80 and 443
cat /tmp/domains.txt | httprobe -p http:8080 -p https:8443 # Check port 80, 443 and 8080 and 8443
```

## Screenshots

Now that you have discovered all the web servers present in scope (between company IPs and all domains and subdomains) you probably don't know where to start.

So let's keep it simple and start taking screenshots of all of them.

Just by taking a look at the main page, you can find strange endpoints that are more likely to be vulnerable.

You can use:
- [**EyeWitness**](https://github.com/FortyNorthSecurity/EyeWitness)
- [**HttpScreenshot**](https://github.com/breenmachine/httpscreenshot)
- [**Aquatone**](https://github.com/michenriksen/aquatone)
- [**shutter**](https://shutter-project.org/downloads/)
- [**webscreenshot**](https://github.com/maaaaz/webscreenshot)

```
cat hosts.txt | aquatone
xdg-open <images>
```

# Password Spray and List of Emails

## Search Domain Emails

It is always good to search for a corporate email list:

- [Hunter](https://hunter.io/)
- [TheHarvester](https://github.com/laramies/theHarvester)
  This local tool can help you find all emails for a domain.

```
theHarvester -d target.com -b all
```

## External Password Spray

Once you get your target's email list, perform a PAssword Spray attack against corporate services (OWA, Lync, IMAP) with [SprayingToolkit](https://github.com/byt3bl33d3r/SprayingToolkit)

```
python3 atomizer.py owa target.com 'Password123' mails.txt
```
```
python3 atomizer.py owa target.com passwords.txt mails.txt -i 0:00:10 # 10 seconds of interval between passwords spray
```

# Cloud Assets

Finding assets in the cloud is a good external practice. 

With specific keywords it is possible to identify the possible assets in the cloud that belong to the objective:

- [**cloud_enum**](https://github.com/initstring/cloud_enum)
- [**cloudlist**](https://github.com/projectdiscovery/cloudlist)

# Github leaked secrets

You should find potentially confidential files posted to public repositories on Github.

[Github Leaked Secrets](https://github.com/0xCGonzalo/Golden-Guide-for-Pentesting/blob/master/Pentesting/External/Enumeration/github-leaked-secrets.md) 

You can also search for leaked secrets in all open repository platforms using: [https://searchcode.com/?q=auth_key](https://searchcode.com/?q=auth_key)

# PlayStore and AppStore

If you don't have any potential intrusion vector at this point, you should consider taking a look at mobile apps. This approach may give you some fresh air to continue your exercise.

# Conclusion

At this point you have already perform all the basic enumeration:

1. Found all the **companies** inside the scope
2. Found all the **assets** belonging to the companies (and perform some vuln scan if in scope)
3. Found all the **domains** belonging to the companies
4. Found all the **subdomains** of the domains (any subdomain takeover?)
5. Found all the **web servers** and took a **screenshot** of them (anything weird worth a deeper look?)

- **You should proceed to the external network scan phase.**
- **You should proceed to the scanning phase of all web assets.**
